% Sbase in MVA.
Sbase = 100;
% Bus Data Matrix
BusData = ...
    [...
     %  1   2  3  4    5      6 (Deg)      7        8       9       10        11        12              13              14         15          16       17 
     %  Bi  i  i  Type FinV   FinAng   PL-MW   QL-MVAR     PGen   QGen MVAR  BaseKV    DesiredVolts    MaxMVAR          MinMVAR     ShuntG      ShuntB  Remote                  
        1   1  1  3    1.060     0.0      0.0      0.0    232.4   -16.9     0.0       1.060           0.0               0.0         0.0         0.0        0;...
        2   1  1  2    1.045   -4.98     21.7     12.7     40.0    42.4     0.0       1.045           50.0              -40.0       0.0         0.0        0;...
        3   1  1  2    1.010  -12.72     94.2     19.0      0.0    23.4     0.0       1.010           40                0.0         0.0         0.0        0;...
        4   1  1  0    1.019  -10.33     47.8     -3.9      0.0     0.0     0.0       0.0             0.0               0.0         0.0         0.0        0;...
        5   1  1  0    1.020   -8.78      7.6      1.6      0.0     0.0     0.0       0.0             0.0               0.0         0.0         0.0        0;...
        6   1  1  2    1.070  -14.22     11.2      7.5      0.0    12.2     0.0       1.070           24.0              -6.0        0.0         0.0        0;...
        7   1  1  0    1.062  -13.37      0.0      0.0      0.0     0.0     0.0       0.0             0.0               0.0         0.0         0.0        0;...
        8   1  1  2    1.090  -13.36      0.0      0.0      0.0    17.4     0.0       1.090           24.0              -6.0        0.0         0.0        0;...
        9   1  1  0    1.056  -14.94     29.5     16.6      0.0     0.0     0.0       0.0             0.0               0.0         0.0         0.19       0;...
       10   1  1  0    1.051  -15.10      9.0      5.8      0.0     0.0     0.0       0.0             0.0               0.0         0.0         0.0        0;...
       11   1  1  0    1.057  -14.79      3.5      1.8      0.0     0.0     0.0       0.0             0.0               0.0         0.0         0.0        0;...
       12   1  1  0    1.055  -15.07      6.1      1.6      0.0     0.0     0.0       0.0             0.0               0.0         0.0         0.0        0;...
       13   1  1  0    1.050  -15.16     13.5      5.8      0.0     0.0     0.0       0.0             0.0               0.0         0.0         0.0        0;...
       14   1  1  0    1.036  -16.04     14.9     -10.10      0.0     0.0     0.0       0.0             0.0               0.0         0.0         0.0        0 ...
    ];

% Branch Data Matrix
BranchData = ...
   [...
   %    1    2  3  4 5 6  7         8           9          10    11    12  13   14  15        16  17     18      19     20    21  
   %    Bi  Bj  i  i i i  R         X           B          i     i     i    i   i   RatTrafo                                                                                                           
        1    2  1  1 1 0  0.01938   0.05917     0.0528     0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
        1    5  1  1 1 0  0.05403   0.22304     0.0492     0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
        2    3  1  1 1 0  0.04699   0.19797     0.0438     0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
        2    4  1  1 1 0  0.05811   0.17632     0.0340     0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
        2    5  1  1 1 0  0.05695   0.17388     0.0346     0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
        3    4  1  1 1 0  0.06701   0.17103     0.0128     0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
        4    5  1  1 1 0  0.01335   0.04211     0.0        0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
        4    7  1  1 1 0  0.0       0.20912     0.0        0     0     0    0   0   0.978     0.0 0.0    0.0     0.0    0.0   0.0;...
        4    9  1  1 1 0  0.0       0.55618     0.0        0     0     0    0   0   0.969     0.0 0.0    0.0     0.0    0.0   0.0;...
        5    6  1  1 1 0  0.0       0.25202     0.0        0     0     0    0   0   0.932     0.0 0.0    0.0     0.0    0.0   0.0;...
        6   11  1  1 1 0  0.09498   0.19890     0.0        0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
        6   12  1  1 1 0  0.12291   0.25581     0.0        0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
        6   13  1  1 1 0  0.06615   0.13027     0.0        0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
        7    8  1  1 1 0  0.0       0.17615     0.0        0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
        7    9  1  1 1 0  0.0       0.11001     0.0        0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
        9   10  1  1 1 0  0.03181   0.08450     0.0        0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
        9   14  1  1 1 0  0.12711   0.27038     0.0        0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
       10   11  1  1 1 0  0.08205   0.19207     0.0        0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
       12   13  1  1 1 0  0.22092   0.19988     0.0        0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0;...
       13   14  1  1 1 0  0.17093   0.34802     0.0        0     0     0    0   0   0.0       0.0 0.0    0.0     0.0    0.0   0.0...
    ];
% Bus Type: 3: Slack, 2:PV, 0:PQ 
BusData(:,6)=(BusData(:,6)/360)*(2*pi);   % Converting degrees to radians
BusData(:,7:10)=BusData(:,7:10)/Sbase;    % Converting P-Q in Per Unit
BusData(:,13:14)=BusData(:,13:14)/Sbase;  % Converting P-Q in Per Unit
bus_type = BusData(:, 4);
Vm = BusData(:, 5);
Va = BusData(:, 6);  % Already converted to radians
V = Vm .* exp(1j * Va);  % Complex voltages

% === Bus Sets ===
gen_buses = find(bus_type == 3 | bus_type == 2);  % Slack + PV
load_buses = find(bus_type == 0);                 % PQ buses

% === Y-bus Construction ===
nb = size(BusData, 1);
Ybus = zeros(nb, nb);
for k = 1:size(BranchData,1)
    i = BranchData(k,1);
    j = BranchData(k,2);
    R = BranchData(k,7);
    X = BranchData(k,8);
    B = BranchData(k,9);
    Z = R + 1j * X;
    y = 1 / Z;

    % Off-diagonal
    Ybus(i,j) = Ybus(i,j) - y;
    Ybus(j,i) = Ybus(i,j);

    % Diagonal
    Ybus(i,i) = Ybus(i,i) + y + 1j*B/2;
    Ybus(j,j) = Ybus(j,j) + y + 1j*B/2;
end

% === Partition Ybus ===
Y_LL = Ybus(load_buses, load_buses);
Y_LG = Ybus(load_buses, gen_buses);

% === Compute F matrix ===
F = -inv(Y_LL) * Y_LG;

% === Compute L-index ===
L_index = zeros(length(load_buses), 1);
for i = 1:length(load_buses)
    Vi = V(load_buses(i));
    sum_term = 0;
    for j = 1:length(gen_buses)
        sum_term = sum_term + F(i,j) * (V(gen_buses(j)) / Vi);
    end
    L_index(i) = abs(1 - abs(sum_term));
end

% === Display Results ===
disp('L-Index for Load Buses:');
disp(table(load_buses, L_index, 'VariableNames', {'Bus', 'L_Index'}));

% === Plot L-index Values ===
figure;
bar(load_buses, L_index, 'FaceColor', [0.2 0.6 0.8]);
grid on;
xlabel('Bus Number');
ylabel('L-Index');
title('L-Index for Load Buses in 14-Bus Transmission System');
ylim([0 1]);
yticks(0:0.1:1);
set(gca, 'FontSize', 12);

% Highlight critical buses (e.g., L-index > 0.5)
hold on;
critical_idx = find(L_index > 0.5);
bar(load_buses(critical_idx), L_index(critical_idx), 'r');
legend('Stable Buses', 'Critical Buses (L > 0.5)', 'Location', 'northwest');

